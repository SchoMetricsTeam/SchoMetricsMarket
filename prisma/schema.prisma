generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String                @id @default(cuid())
  identifier          String                @unique
  name                String
  password            String
  role                Role                  @default(USER)
  userType            UserType              @default(SELLER)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  purchasesMade       MaterialPurchase[]    @relation("BuyerPurchases")
  materialsSold       MaterialPurchase[]    @relation("SellerSales")
  profile             Profile?
  recyclableMaterials RecyclableMaterial[]
  stripeAccount       StripeConnectAccount?

  @@map("users")
}

model Profile {
  id         String  @id @default(cuid())
  email      String  @unique
  city       String?
  state      String?
  postalCode String?
  address    String?
  phone      String?
  rfc        String? @unique
  cct        String? @unique
  avatarUrl  String?
  userId     String  @unique
  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model RecyclableMaterial {
  id           String                    @id @default(cuid())
  folio        String                    @unique
  title        String
  materialType MaterialType
  quantity     Float
  city         String
  state        String
  postalCode   String
  address      String
  location     String
  schedule     String
  status       MaterialStatus            @default(AVAILABLE)
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  userId       String
  images       RecyclableMaterialImage[]
  purchases    MaterialPurchase[]
  user         User                      @relation(fields: [userId], references: [id])

  @@map("recyclable_materials")
}

model RecyclableMaterialImage {
  id                   String             @id @default(cuid())
  s3Key                String
  order                Int
  recyclableMaterialId String             @map("RecyclableMaterialId")
  createdAt            DateTime           @default(now())
  recyclableMaterial   RecyclableMaterial @relation(fields: [recyclableMaterialId], references: [id], onDelete: Cascade)

  @@index([recyclableMaterialId])
  @@map("RecyclableMaterialImage")
}

model MaterialPurchase {
  id                    String             @id @default(cuid())
  purchaseFolio         String
  buyerId               String
  buyerName             String
  buyerEmail            String
  buyerRFC              String
  buyerPhone            String
  buyerAddress          String
  sellerId              String
  materialId            String
  materialTitle         String
  materialType          MaterialType
  quantity              Float
  pricePerKg            Float
  totalAmount           Float
  platformFeeAmount     Float?
  sellerAmount          Float?
  transporterName       String
  transporterPhone      String
  transporterCredential String
  collectionDate        DateTime
  collectionTime        String
  collectionAddress     String
  paymentStatus         PaymentStatus      @default(PENDING)
  paymentMethod         String?
  stripePaymentIntentId String?
  stripeTransferId      String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  buyer                 User               @relation("BuyerPurchases", fields: [buyerId], references: [id], onDelete: Cascade)
  material              RecyclableMaterial @relation(fields: [materialId], references: [id])
  seller                User               @relation("SellerSales", fields: [sellerId], references: [id], onDelete: Cascade)

  @@map("material_purchases")
}

model StripeConnectAccount {
  id                  String        @id @default(cuid())
  userId              String        @unique
  stripeAccountId     String        @unique
  accountStatus       AccountStatus @default(PENDING)
  chargesEnabled      Boolean       @default(false)
  payoutsEnabled      Boolean       @default(false)
  detailsSubmitted    Boolean       @default(false)
  onboardingComplete  Boolean       @default(false)
  onboardingLink      String?
  onboardingExpiresAt DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("stripe_connect_accounts")
}

model Report {
  id              String         @id @default(cuid())
  title           String
  targetType      ReportTarget
  reportUserType  ReportUserType
  reportStatus    ReportStatus   @default(PENDIENTE)
  sellerName      String
  rfc             String
  cct             String?
  ownerName       String
  ownerEmail      String
  ownerIdentifier String
  ownerUserType   String
  ownerRFC        String
  ownerCCT        String?
  ownerCity       String?
  ownerState      String?
  ownerPostalCode String?
  ownerAddress    String?
  ownerPhone      String?
  content         String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("reports")
}

enum UserType {
  SELLER
  BUYER
  ADMIN
}

enum Role {
  USER
  ADMIN
}

enum AccountStatus {
  PENDING
  ACTIVE
  RESTRICTED
  REJECTED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum MaterialType {
  PLASTICO
  PAPEL
  VIDRIO
  ORGANICO
  ALUMINIO
}

enum MaterialStatus {
  AVAILABLE
  PENDING
  PURCHASED
}

enum ReportTarget {
  Vendedor
  Comprador
}

enum ReportUserType {
  Comprador
  Vendedor
}

enum ReportStatus {
  PENDIENTE
  REVISION
  COMPLETADO
}
